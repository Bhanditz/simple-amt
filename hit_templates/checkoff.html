<html>
  <head>
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">    
    <style>
    #clipper {
      position: relative;
      max-width: 100%;
      margin-top: 12px;
      overflow: hidden;
      padding-bottom: 30px;
    }
    #zoomin {
      position: absolute;
      left: 0;
    }
    #phrase {
      font-weight: bold;
    }
    .locator {
      height: 0; width: 100%; position: relative;
    }
    .aligner {
      height: 0; width: 100%; position: absolute;
    }
    #checker {
      height: 23px;
      margin-top: -20px;
    }
    #checker2 {
      height: 30px;
      margin-top: 2px;
      font-size: 150%;
    }
    #checker .check, #checker2 .check {
      display: inline-block;
      text-align: center;
      vertical-align: top;
      text-shadow: 0 3px 5px #000;
      border-bottom: 2px solid transparent;
      border-top: 3px solid transparent;
      height: 100%;
    }
    .check.checked:before {
      content: "\2714";
      color: lime;
    }
    .check.crossed:before {
      content: "\2716";
      color: red;
    }
    #checker .check.selected {
      border-bottom: 2px solid blue;
    }
    #checker2 .check.selected {
      border-top: 3px solid blue;
    }
    .centered {
      text-align: center;
    }
    .noselect {
      user-select: none;
    }
    .choiceblock {
      user-select: none;
      display: inline-block;
      margin: auto;
      width: auto;
    }
    label {
      display: block;
      text-align: left;
    }
    </style>

  </head>
  <body>
    <div class='container'>
      <h2>Image Region Labels</h2>
      <p>
      1. Consider the <span class="wordword">word</span>:</p>
      <h2 class="centered" style="margin-top:0">
        "<span id="phrase"></span>"</h2>
      <p>
      2. Examine the highlighted regions of each of the
      <span class="num">16</span> images.  Pointing at the small images
      will scroll the large versions into view.
      <p>click once on the image to make a
      <span class="check checked" style="margin-bottom:3px"></span>
      if the <span class="wordword">word</span> is a good description of the
      highligted region.</p>
      <p>click twice on the image to make a
      <span class="check crossed" style="margin-bottom:3px"></span>
      if not.</p>
      <div class="noselect">
      <img class="example" id="filmstrip" style="max-width:100%">
      <div class="locator">
      <div class="aligner">
        <div id="checker"></div>
      </div>
      </div>

      <div id="clipper">
      <div id="zoomin">
        <img class="example">
        <div class="locator">
        <div class="aligner">
          <div id="checker2"></div>
        </div>
        </div>
      </div>
      <img class="example" style="visibility:hidden">
      </div>
      </div>
      <p>
      3. Submit once you have evaluated all <span class="num">16</span>.
      <p>
    </div>

    {% include "simpleamt.html" %}

    <script>
      $(function() {
        // Define default input to be used when developing this HIT.
        var DEFAULT_INPUT = {
          image: 'http://people.csail.mit.edu/davidbau/dissection/reference_places205/image/conv5-0000.jpg',
          phrase: 'outdoor roof'
        };

        var lastTime = (new Date).getTime();
        var lastMove = null;
        $(document).on('mousemove', function(ev) {
          if (ev.pageY >= $('#filmstrip').offset().top &&
              ev.pageY <= $('#clipper').offset().top +
              $('#clipper').height()) {
            lastMove = ev;
            var percent = (ev.pageX - $('#filmstrip').offset().left -
                $('#filmstrip').height() / 2) /
              ($('#filmstrip').width() - $('#filmstrip').height());
            var maxpos = $('#zoomin').width() - $('#clipper').width();
            var pos = percent * maxpos;
            pos = Math.max(0, Math.min(maxpos, pos));
            $('#zoomin').prop('targetleft', -pos);
            showselection(hittest(lastMove));
          }
        });

        $(document).on('mousedown', function(ev) {
          if ($('#submit-btn').prop('disabled')) {
            // Do not check off images if the hit is preview only.
            return;
          }
          var selection = hittest(ev);
          if (selection >= 0) {
            var nth = $('#checker,#checker2').
              find(':nth-child(' + (selection + 1) + ')');
            if (nth.hasClass('checked')) {
              nth.removeClass('checked').addClass('crossed');
            } else if (nth.hasClass('crossed')) {
              nth.removeClass('crossed').addClass('checked');
            } else if (ev.which == 3) {
              nth.addClass('crossed');
            } else {
              nth.addClass('checked');
            }
          }
        });

        $(document).on('contextmenu dragstart', '.noselect', function() {
          return false;
        });

        function animate() {
          var thisTime = (new Date).getTime();
          var diffTime = (thisTime - lastTime) / 20;
          var curr = parseFloat($('#zoomin').css('left'));
          var diff = $('#zoomin').prop('targetleft') - curr;
          if (Math.abs(diff) > 1) {
            $('#zoomin').css('left', curr + Math.min(1, diffTime) * (diff < 0 ?
                   -Math.sqrt(-diff) : Math.sqrt(diff)));
            showselection(hittest(lastMove));
          }
          lastTime = thisTime;
          requestAnimationFrame(animate);
        };
        animate();

        function hittest(ev) {
          if (!ev) {
            return -1;
          }
          var selected;
          if (ev.pageY >= $('#clipper').offset().top &&
              ev.pageY <= $('#clipper').offset().top +
              $('#clipper').height()) {
            return Math.floor(
                (ev.pageX - $('#zoomin').offset().left) /
                $('#zoomin').height());
          } else if (ev.pageY >= $('#filmstrip').offset().top &&
                ev.pageY < $('#clipper').offset().top) {
            return Math.floor(
                (ev.pageX - $('#filmstrip').offset().left) /
                $('#filmstrip').height());
          }
        }

        function showselection(n) {
          $('#checker .check.selected').removeClass('selected');
          $('#checker .check').eq(n).addClass('selected');
          $('#checker2 .check.selected').removeClass('selected');
          $('#checker2 .check').eq(n).addClass('selected');
        }

        function main() {
          // Read input to the HIT. In development the default input will be
          // used, and in deployment actual input will be used.
          var input = simpleamt.getInput(DEFAULT_INPUT);
          var n = input.n || 16;

          $('#checker').text('');
          $('#checker2').text('');
          for (var j = 0; j < n; ++j) {
            $('#checker').append('<div class="check">');
            $('#checker2').append('<div class="check">');
          }
          $('#checker .check').css({width: (100 / n) + '%'})
          $('#checker2 .check').css({width: (100 / n) + '%'})

          // Use the input to set up the UI.
          $('.example').attr('src', input.image);
          $('#zoomin').css({left: 0}).prop('targetleft', 0);
          var phrase = input.phrase.replace(/-[a-z]$/, '').replace(/-/g, ' ');
          if (/ /.test(phrase)) {
            $('.wordword').text('phrase');
          } else {
            $('.wordword').text('word');
          }
          $('.num').text(n);

          $('#phrase').text(input.phrase);

          // If the HIT is not in preview mode, then we need to enable the UI
          // and set up the logic for submitting.
          if (!simpleamt.isPreview()) {
            enable_ui();

            // You need to call this in every HIT; if you forget then you will
            // get an error message when you try and submit the HIT.
            simpleamt.setupSubmit();

            // Set up a click handler for the submit button.
            // Typically this will validate user output and either submit the
            // HIT if the data is good or show an error message to the user if
            // the data is bad. If this click handler returns false then the
            // HIT will not be submitted.
            // WARNING: If the click handler throws an exception
            // then by default the HIT will be submitted; this is a fertile
            // source of bugs.
            $('#submit-btn').click(function() {

              // Validate the output
              var missed = n - ($('#checker .checked').length +
                  $('#checker .crossed').length);
              if (missed > 0) {
                alert('Please evaluate all ' + n + ' images');
                return false;
              } else {
                var result = $('#checker .check').map(function() {
                  return $(this).hasClass('checked');
                });
                simpleamt.setOutput({
                  unit: input.unit,
                  phrase: input.phrase,
                  checked: result
                });
              }
            })
          }
        }

        function enable_ui() {
          // Enable the UI specific to our HIT.
          $('input[name=choice]').prop('disabled', false);

          // Enable the submit button. You must do this in every HIT.
          $('#submit-btn').prop('disabled', false);
        }

        main();

      });
    </script>
  </body>
</html>
